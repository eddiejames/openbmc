From 6232fc594c46aefbf93e51b1d1a986f410efe540 Mon Sep 17 00:00:00 2001
From: Andrew Jeffery <andrew@aj.id.au>
Date: Wed, 4 Sep 2019 13:37:34 +0930
Subject: [PATCH 1/3] ram: aspeed: Add DDR4 option for 400Mbps

Signed-off-by: Andrew Jeffery <andrew@aj.id.au>
---
 drivers/ram/aspeed/Kconfig             | 10 +++++++++-
 drivers/ram/aspeed/sdram_ast2600.c     | 11 ++++++++++-
 drivers/ram/aspeed/sdram_phy_ast2600.h |  4 ++--
 3 files changed, 21 insertions(+), 4 deletions(-)

diff --git a/drivers/ram/aspeed/Kconfig b/drivers/ram/aspeed/Kconfig
index 85fe6a2..0c9d360 100644
--- a/drivers/ram/aspeed/Kconfig
+++ b/drivers/ram/aspeed/Kconfig
@@ -2,6 +2,14 @@ choice
 	prompt "DDR4 target data rate"
 	default ASPEED_DDR4_1600
 
+config ASPEED_DDR4_400
+        bool "DDR4 targets at 400Mbps"
+        depends on DM && OF_CONTROL && ARCH_ASPEED
+        select RAM
+        select SPL_RAM if SPL
+        help
+                select DDR4 target data rate at 400M
+
 config ASPEED_DDR4_800
         bool "DDR4 targets at 800Mbps"
         depends on DM && OF_CONTROL && ARCH_ASPEED
@@ -46,4 +54,4 @@ config ASPEED_ECC
         select SPL_RAM if SPL
         default n
         help
-                enable SDRAM ECC function
\ No newline at end of file
+                enable SDRAM ECC function
diff --git a/drivers/ram/aspeed/sdram_ast2600.c b/drivers/ram/aspeed/sdram_ast2600.c
index e209f3d..f2d4377 100644
--- a/drivers/ram/aspeed/sdram_ast2600.c
+++ b/drivers/ram/aspeed/sdram_ast2600.c
@@ -55,9 +55,14 @@
 //#define SCU_MPLL_EXT_400M		0x0000003F
 #define SCU_MPLL_FREQ_200M		0x0078007F
 #define SCU_MPLL_EXT_200M		0x0000003F
+#define SCU_MPLL_FREQ_100M		0x0078003F
+#define SCU_MPLL_EXT_100M		0x0000001F
 
 /* MPLL configuration */
-#if defined(CONFIG_ASPEED_DDR4_800)
+#if defined(CONFIG_ASPEED_DDR4_400)
+#define SCU_MPLL_FREQ_CFG		SCU_MPLL_FREQ_100M
+#define SCU_MPLL_EXT_CFG		SCU_MPLL_EXT_100M
+#elif defined(CONFIG_ASPEED_DDR4_800)
 #define SCU_MPLL_FREQ_CFG		SCU_MPLL_FREQ_200M
 #define SCU_MPLL_EXT_CFG		SCU_MPLL_EXT_200M
 #elif defined(CONFIG_ASPEED_DDR4_1600)
@@ -90,6 +95,7 @@
 #define DDR4_MR6_MODE           0x00000400
 #define DDR4_TRFC_1600		0x467299f1
 #define DDR4_TRFC_800		0x23394c78
+#define DDR4_TRFC_400		0x111c263c
 #endif /* end of "#if defined(CONFIG_FPGA_ASPEED) ||                           \
 	  defined(CONFIG_ASPEED_PALLADIUM)" */
 
@@ -103,6 +109,9 @@
 #elif defined(CONFIG_ASPEED_DDR4_800)
 #define DDR4_TRFC			DDR4_TRFC_800
 #define DDR4_PHY_TRAIN_TRFC		0x618
+#elif defined(CONFIG_ASPEED_DDR4_400)
+#define DDR4_TRFC			DDR4_TRFC_400
+#define DDR4_PHY_TRAIN_TRFC		0x30c
 #else
 #error "undefined tRFC setting"
 #endif	/* end of "#if (SCU_MPLL_FREQ_CFG == SCU_MPLL_FREQ_400M)" */
diff --git a/drivers/ram/aspeed/sdram_phy_ast2600.h b/drivers/ram/aspeed/sdram_phy_ast2600.h
index 4543f2b..7d90cc7 100644
--- a/drivers/ram/aspeed/sdram_phy_ast2600.h
+++ b/drivers/ram/aspeed/sdram_phy_ast2600.h
@@ -1,7 +1,7 @@
 #define DDR_PHY_TBL_CHG_ADDR            0xaeeddeea
 #define DDR_PHY_TBL_END                 0xaeededed
 
-#if defined(CONFIG_ASPEED_DDR4_800)
+#if defined(CONFIG_ASPEED_DDR4_800) || defined (CONFIG_ASPEED_DDR4_400)
 u32 ast2600_sdramphy_config[165] = {
 	0x1e6e0100,	// start address
 	0x00000000,	// phyr000
@@ -337,4 +337,4 @@ u32 ast2600_sdramphy_config[165] = {
 	0x00000059,	// phyr1f4
 	0xaeededed,	// end
 };
-#endif
\ No newline at end of file
+#endif
-- 
1.8.3.1

